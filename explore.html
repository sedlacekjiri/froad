<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>F-Roads Iceland</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:'Poppins',sans-serif; overflow:hidden; }
    #map { position:absolute; top:0; left:0; width:100%; height:100vh; z-index:1; }

    /* ---- Side panel ---- */
    #sidePanel{
      position:absolute; left:0; bottom:-100%; width:100%; height:55vh;
      background:#fdfbfb; padding:20px; box-sizing:border-box;
      box-shadow:0 -2px 6px rgba(0,0,0,.3);
      display:flex; flex-direction:column; overflow-y:auto;
      transition:bottom .25s ease-out; z-index:1500; overscroll-behavior:contain;
    }
    #sidePanel.open{ bottom:0; display:block; }
    #sidePanel img{ width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:16px; }

    @media (max-width:768px){ #sidePanel{ width:100vw; left:0; right:0; max-width:none; overflow-x:hidden; } }

    .road-label-icon div{
      display:inline-block; background:#000; color:#fff; border:1px solid #fff; border-radius:5px;
      padding:4px 6px; font-size:12px;
    }
    .road-label-icon.dimmed div{ opacity:.4; background:#aaa; }

    #closePanel{
      position:absolute; top:12px; right:12px; background:rgba(255,255,255,.9); border:1px solid #000;
      font-size:1.5em; padding:4px 8px; border-radius:4px; cursor:pointer; margin-bottom:8px; align-self:flex-end;
      z-index:1; color:#000;
    }

    /* Locate control (current position) */
    .leaflet-control-locate{ margin-top:10px !important; }
    .leaflet-control-locate a{
      display:flex; align-items:center; justify-content:center; width:34px; height:34px; background:#fff;
      border:1px solid #ccc; border-radius:4px; cursor:pointer;
    }
    .leaflet-control-locate svg{ width:18px; height:18px; display:block; }

    #vehicleSelect{
      background-color:#fff !important; color:#000 !important;
      font-family:'Poppins',sans-serif !important; font-size:14px;
      padding:4px 8px; border-radius:4px; border:1px solid #ccc;
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
    }

    /* ---- F-Roads Search Box ---- */
    #roadSearchContainer {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      width: 80%;
      max-width: 400px;
    }

    #roadSearchBox {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      font-family: 'Poppins', sans-serif;
    }

    #searchIcon {
      flex-shrink: 0;
      color: #666;
    }

    #roadSearchInput {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      color: #000;
      background: transparent;
      font-family: 'Poppins', sans-serif;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #roadSearchInput::placeholder {
      color: #999;
    }

    #clearSearch {
      flex-shrink: 0;
      background: transparent;
      border: none;
      color: #666;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: opacity 0.2s ease;
    }

    #clearSearch:hover {
      color: #000;
    }

    #clearSearch.show {
      display: flex;
    }

    #searchResults {
      margin-top: 8px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
    }

    #searchResults.show {
      display: block;
    }

    .search-result-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      color: #000;
      transition: background 0.2s ease;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: #f5f5f5;
    }

    .search-result-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .search-result-info {
      font-size: 12px;
      color: #666;
    }

    .search-no-results {
      padding: 16px;
      text-align: center;
      color: #999;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }

    /* Hide search on mobile when gallery is open */
    body.gallery-open #roadSearchContainer {
      display: none !important;
    }

    @media (max-width: 768px) {
      #roadSearchContainer {
        top: 20px;
        left: 80px;
        right: 20px;
        width: auto;
        max-width: 280px;
        transform: none;
      }
    }

    /* ---- Weather card (Temp + Wind) ---- */
    .wx-card{
      display:flex; align-items:center; gap:11px;
      padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
      margin:6px 0 12px;
    }
    .wx-temp{ display:flex; align-items:center; gap:10px; }
    .wx-icon svg{ width:28px; height:28px; display:block; color:#111; }
    .wx-temp-num{ font-size:16px; line-height:1; font-weight:700; color:#e23b3b; }
    .wx-temp-num .unit{ margin-left:3px; font-size:14px; font-weight:600; color:#e23b3b; opacity:.9; }

    .wx-sep{ width:1px; align-self:stretch; background:linear-gradient(180deg,#e5e7eb,transparent 70%); }

    .wx-wind{ display:flex; align-items:center; gap:10px; }
    .wx-compass svg{ width:30px; height:30px; display:block; }
    .wx-compass .arrow{ transform-origin:22px 22px; transition:transform .25s ease; }

    .wx-wind-info{ display:flex; flex-direction:column; line-height:1.1; }
    .wx-wind-speed{ font-weight:800; color:#e23b3b; font-size:16px; }
    .wx-wind-speed .unit{ margin-left:4px; font-size:12px; font-weight:700; color:#e23b3b; opacity:.9; }
    .wx-wind-dir{ font-size:12px; color:#374151; opacity:.9; }

    .wx-precip{
      display:flex; align-items:center; gap:8px;
      background:#fff;
    }
    .wx-precip-icon svg{ width:22px; height:22px; display:block; color:#2563eb; }
    .wx-precip-val{ font-weight:800; color:#111; font-size:14px; line-height:1; }
    .wx-precip-val .unit{ margin-left:4px; font-size:12px; font-weight:700; color:#6b7280; }


    /* ---- River crossings UI ---- */
    #rc-section{ margin-top:12px; }
    #rc-title{ font-weight:600; margin:10px 0 6px; display:flex; align-items:center; gap:8px; }
    #rc-list{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .rc-item{
      display:grid; grid-template-columns:30px 1fr auto;
      align-items:center; gap:10px; padding:8px 10px;
      border:1px solid #e5e7eb; border-radius:8px; background:#fff;
    }
    .rc-name{ font-weight:600; }
    .rc-metrics{ font-size:12px; color:#374151; }
    .rc-right{ display:flex; align-items:center; gap:8px; }
    .rc-badge{ font-size:12px; font-weight:600; padding:2px 8px; border-radius:999px; border:1px solid transparent; }
    .rc-badge.easy{ color:#166534; background:#dcfce7; border-color:#86efac; }
    .rc-badge.medium{ color:#92400e; background:#ffedd5; border-color:#fed7aa; }
    .rc-badge.hard{ color:#7f1d1d; background:#fee2e2; border-color:#fecaca; }
    .rc-badge.extreme{ color:#7c2d12; background:#ffedd5; border-color:#fdba74; box-shadow:0 0 0 2px #f59e0b inset; }

    /* Crossing icon holder */
    .rc-icon{ width:28px; height:28px; display:inline-grid; place-items:center; }
    .rc-icon svg{ width:28px; height:28px; display:block; }

    .rc-btn{ border:1px solid #111; background:#fff; color:#111; border-radius:6px; padding:4px 8px; font-size:12px; cursor:pointer; }
    .rc-btn:hover{ background:#f3f4f6; }


    .info-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  margin: 10px 0;
  background: #fff;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  font-size: 14px;
}

.info-label {
  font-weight: 600;
  color: #111;
  min-width: 110px; /* sjednocen√≠ zarovn√°n√≠ */
}

Lep≈°√≠ oddƒõlen√≠ sekce info */
#roadDetails {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.info-title {
  display: block;
  margin: 15px 0;
}

/* Container pro obr√°zek + tlaƒç√≠tko */
#roadImageWrapper {
  position: relative;
  display: block;
  margin-bottom: 16px;
}
#roadImageWrapper img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 8px;
  display: block;
}

/* Gallery button v overlay */
#spGalleryBtn {
  position: absolute;
  bottom: 10px;   /* m√≠sto top:10px */
  right: 10px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  font-size: 14px;
  font-weight: 600;
  border: 1px solid #111;
  border-radius: 8px;
  background: rgba(255,255,255,0.85);
  color: #111;
  cursor: pointer;
  backdrop-filter: blur(4px);
}
#spGalleryBtn:hover {
  background: rgba(255,255,255,1);
}

#spGalleryBtn svg {
  width: 16px;
  height: 16px;
  display: block;
}

/* Fullscreen gallery overlay ‚Äì navrchu v≈°eho */
#galleryOverlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 1);
  z-index: 9999999;          /* bylo m√©nƒõ ‚Äì teƒè nad Leafletem i tv√Ωmi UI (vehicle filter ~1000) */
  display: none;
  flex-direction: column;
}
#galleryOverlay.open { display: flex; }

#galleryHeader {
  display:flex; 
  align-items:center; 
  justify-content:space-between;
  padding:12px 16px;
  color:#000000; 
  font-weight:600;
  font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; /* Poppins */
  background:#fff;              /* svƒõtl√Ω pruh jako ostatn√≠ UI */
  border-bottom:1px solid #e5e7eb;
}

/* Pruh s obsahem ‚Äì VERTIK√ÅLNƒö pod sebou */
#galleryStrip{
  flex:1;
  display:block;            /* staƒç√≠ blok ‚Äì budou pod sebou */
  overflow-y:auto;          /* vertik√°ln√≠ scroll */
  overflow-x:hidden;
  padding:16px;
}

/* Ka≈æd√Ω slide je ‚Äûkarta‚Äú uprost≈ôed, max ≈°√≠≈ôka kv≈Øli ƒçitelnosti */
.gal-slide{
  width:min(100%, 1200px);
  margin:0 auto 16px auto;
  border-radius:12px; overflow:hidden; background:#ffffff;
}

/* Obr√°zek se p≈ôizp≈Øsob√≠ ‚Äì ≈æ√°dn√© o≈ôez√°v√°n√≠, v√Ω≈°ka max 80vh */
.gal-slide img{
  display:block;
  width:100%;
  border-radius:12px;               /* vypln√≠ ≈°√≠≈ôku kontejneru */
  height:auto;              /* ponech√° pomƒõr stran */
  object-fit:contain;       /* bez o≈ôezu */
}
.gal-cap{ color:#000000; font-size:14px; padding:6px 10px; text-align:center; }

/* Voliteln√©: skryj scrollbar na mobilu / zjemni vzhled */
#galleryStrip::-webkit-scrollbar { width: 10px; }
#galleryStrip::-webkit-scrollbar-thumb { background:#666; border-radius:8px; }
#galleryStrip::-webkit-scrollbar-track { background:transparent; }

#closeGallery {
  background: #fff;
  border: 1px solid #111;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background .2s ease;
}
#closeGallery:hover {
  background: #f3f4f6;
}
#closeGallery svg {
  width: 18px;
  height: 18px;
  stroke: #111;
}



/* Kdy≈æ je otev≈ôen√° galerie, schovej tyto prvky */
body.gallery-open #vehicleFilter { display:none !important; }
/* Pokud m√°≈° dal≈°√≠ Leaflet ovladaƒçe, schovej cel√Ω control container */
body.gallery-open .leaflet-control-container { display:none !important; }

/* Overlay ‚Äì opravdu navrchu, fullscreen */
#galleryOverlay{
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 1);
  z-index: 2147483647; /* maximum prakticky v≈°ude */
  display: none;
  flex-direction: column;
}
#galleryOverlay.open{ display:flex; }

/* Kdy≈æ je galerie otev≈ôen√°, zru≈° possible 'transform' na hlavn√≠ch bloc√≠ch,
   aby 'position: fixed' overlaye neuv√≠zl v jejich stacking contextu (iframe/Webflow bug). */
body.gallery-open #map,
body.gallery-open #sidePanel,
body.gallery-open #vehicleFilter {
  transform: none !important;
  filter: none !important;
  perspective: none !important;
}

/* A rovnou schovej konfliktn√≠ UI nad mapou */
body.gallery-open #vehicleFilter,
body.gallery-open .leaflet-control-container {
  display: none !important;
}

/* ===== Unified POI Popup (Campsites + Huts) ===== */
/* Leaflet shell */
.leaflet-container .poi-popup .leaflet-popup-content-wrapper{
  padding:0;
  border:1px solid #e5e7eb;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  background:#fff;
}
.leaflet-container .poi-popup .leaflet-popup-content{
  margin:0;
  font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
.leaflet-container .poi-popup .leaflet-popup-tip{
  background:#fff;
  box-shadow:1px 1px 0 0 #e5e7eb;
}

/* Close button ‚Äì m√≠rn√Ω radius, lad√≠ s UI */
.leaflet-container .poi-popup a.leaflet-popup-close-button{
  position:absolute; right:8px; top:8px;
  width:28px; height:28px; line-height:26px;
  color:#111; background:#fff;
  border:1px solid #111; border-radius:8px;
  opacity:1;
}
.leaflet-container .poi-popup a.leaflet-popup-close-button:hover{ background:#f3f4f6; }

/* Card layout */
.poi-card{ background:#fff; border-radius:14px; overflow:hidden; }
.poi-cover{ width:100%; height:140px; object-fit:cover; display:block; }
.poi-body{ padding:12px 14px; }

.poi-title{
  font-weight:700; font-size:15px; color:#111; margin:0 0 6px;
}
.poi-desc{
  font-size:13px; color:#374151; margin:0 0 10px;
}

/* Actions ‚Äì CTA vpravo */
.poi-actions{
  display:flex; justify-content:flex-end; align-items:center; gap:8px; flex-wrap:wrap;
}

/* CTA button (enforces black text) */
.poi-btn,
.poi-btn:link,
.poi-btn:visited{
  display: block;                 /* m√≠sto inline-flex, zabere cel√Ω ≈ô√°dek */
  width: 100%;
  margin: 0 auto;                 /* vycentruje d√≠ky auto margin≈Øm */
  padding: 10px 14px;             /* p≈ô√≠jemn√Ω vnit≈ôn√≠ spacing */
  border: 1px solid #111;
  border-radius: 8px;
  background: #fff;
  color: #111 !important;
  font-weight: 600;
  font-size: 13px;
  text-align: center;             /* text doprost≈ôed */
  text-decoration: none !important;
  box-sizing: border-box;         /* jistota ≈æe padding se poƒç√≠t√° do ≈°√≠≈ôky */
}
.poi-btn:hover{ background:#f3f4f6; }
.poi-btn svg{ width:16px; height:16px; display:inline-block; vertical-align:middle; }


/* Neutralize generic anchor colors inside popup */
.leaflet-container .poi-popup a{ color:inherit; }

/* Small screens ‚Äì trochu kompaktnƒõj≈°√≠ */
@media (max-width: 420px){
  .poi-cover{ height:150px; }
  .poi-title{ font-size:14px; }
  .poi-desc{ font-size:12px; }
  .poi-btn{ font-size:12px; padding:6px 8px; }
}

/* ==== Road status badge ==== */
#roadStatusBadge {
  position: absolute;
  top: 12px;
  left: 12px;
  padding: 4px 12px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  border: 1px solid transparent;
  z-index: 2;
}

#roadStatusBadge.open {
  color: #166534;
  background-color: #dcfce7;
  border-color: #86efac;
}

#roadStatusBadge.closed {
  color: #7f1d1d;
  background-color: #fee2e2;
  border-color: #fecaca;
}

#roadStatusBadge.unknown {
  color: #ffffff;
  background-color: #9ca3af;
  border-color: #6b7280;
}

#updatesPanel {
  position:absolute;
  left:0; bottom:-100%;
  width:100%; height:55vh;
  background:#fdfbfb;
  padding:20px;
  box-sizing:border-box;
  box-shadow:0 -2px 6px rgba(0,0,0,.3);
  transition:bottom .25s ease-out;
  z-index:1500;
  overflow-y:auto;
}
#updatesPanel.open { bottom:0; }

#updatesPanel h2 { margin-top:0; font-size:18px; }

#closeUpdates {
  position:absolute; top:12px; right:12px;
  background:#fff; border:1px solid #111; border-radius:4px;
  font-size:1.2em; padding:2px 8px; cursor:pointer;
  color:#111; /* ƒçern√° ikonka/text */
}
#closeUpdates:hover { background:#f3f4f6; }

.updates-list { list-style:none; margin:0; padding:0; display:grid; gap:10px; }
.update-item {
  padding:10px;
  border:1px solid #e5e7eb; border-radius:8px;
  background:#fff;
}
.update-item.warning { border-left:4px solid #dc2626; }
.update-item.info    { border-left:4px solid #2563eb; }
.update-item.notice  { border-left:4px solid #ffe600; }
.update-time { font-size:12px; color:#6b7280; margin-bottom:4px; }

#updatesBtn {
  position: absolute;
  top: 220px;          /* 170 + 40 + 10 */
  left: 20px;
  z-index: 1000;
  border-radius: 10px;
  overflow: hidden;
}

#updatesBtn a {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: #ffe600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
}

#updatesBtn .updates-icon {
  font-weight: 900;
  font-size: 18px;
  color: #000;
  font-family: 'Poppins', sans-serif;
  line-height: 1;
}

#updatesBtn a:hover {
  background: #ffd700;
}

#closeUpdates svg line {
  stroke: #000;
}

/* SOS ‚Äì 112 (hned pod Updates) */
#sosBtn{
  position: absolute;
  top: 270px;          /* 220 + 40 + 10 */
  left: 20px;
  z-index: 1000;
}

#sosBtn a{
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: #ef4444;
  color: #fff;
  font: 700 13px/1 'Poppins', sans-serif;
  border-radius: 10px;
  border: none;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

#sosBtn a:hover{
  background: #f05252;
}

/* Current Location button */
#currentLocationBtn{
  position: absolute;
  top: 120px;          /* After zoom buttons: 70 + 40 + 10 */
  left: 20px;
  z-index: 1000;
}

#currentLocationBtn a{
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: #ffffff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
}

#currentLocationBtn img{
  width: 20px;
  height: 20px;
}

#currentLocationBtn a:hover{
  background: #f3f3f3;
}

/* Satellite Toggle button */
#satelliteBtn{
  position: absolute;
  top: 170px;          /* 120 + 40 + 10 */
  left: 20px;
  z-index: 1000;
}

#satelliteBtn a{
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: #ffffff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
}

#satelliteBtn img{
  width: 20px;
  height: 20px;
}

#satelliteBtn a:hover{
  background: #f3f3f3;
}


html, body { font-family: 'Poppins', sans-serif; }

/* ===== Bottom-left card (subtle) ===== */
#bottomInfoBox{
  position:fixed; left:12px; bottom:12px;
  display:flex; flex-direction:column; gap:4px; align-items:flex-start;
  padding:8px 10px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(17,17,17,.08);
  border-radius:10px;
  box-shadow:0 6px 18px rgba(0,0,0,.10);
  z-index: 650; /* pod modalem, nad mapou */
  font-family:'Poppins',sans-serif; color:#111;
  backdrop-filter: blur(4px);
}
#currentTime{
  font-size:12px; font-weight:600; opacity:.75;
}

/* nen√°padn√Ω odkaz m√≠sto v√Ωrazn√©ho tlaƒç√≠tka */
#openDisclaimer{
  appearance:none;
  border:none;
  background:transparent;
  color:#111;                 /* ƒçern√Ω text */
  cursor:pointer;
  padding:0; margin:0;
  font-size:12px;
  font-weight:500;
  text-decoration:underline;  /* vypad√° jako odkaz */
  opacity:.6;
  transition:opacity .15s ease, color .15s ease;
}
#openDisclaimer:hover{
  opacity:1;
  color:#333;                 /* na hover jen trochu tmav≈°√≠/≈°ed≈°√≠ */
}


/* ===== Modal nad V≈†√çM (p≈ôekryje mapu, ikony, side panel, atd.) ===== */
#legalModalBackdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.45);
  opacity:0; visibility:hidden; transition:opacity .2s ease;
  z-index: 2147483646; /* t√©mƒõ≈ô maximum */
}
#legalModalBackdrop.open{ opacity:1; visibility:visible; }

#legalModal{
  position:fixed; left:50%; top:50%;
  transform:translate(-50%,-50%) scale(.97);
  width:min(640px, 92vw); max-height:85vh; overflow:auto;
  background:#fff; color:#111; font-family:'Poppins',sans-serif;
  border:1px solid #e5e7eb; border-radius:14px;
  box-shadow:0 24px 60px rgba(0,0,0,.25);
  opacity:0; visibility:hidden; transition:opacity .2s ease, transform .2s ease;
  z-index: 2147483647; /* nad v≈°√≠m */
  display:flex; flex-direction:column;
}
#legalModal.open{ opacity:1; visibility:visible; transform:translate(-50%,-50%) scale(1); }

/* Close (jedin√Ω) */
#legalClose.closeBtn{
  position:absolute; top:12px; right:12px;
  border:1px solid #111; background:#fff; color:#111;
  width:32px; height:32px; border-radius:8px;
  display:inline-grid; place-items:center; cursor:pointer; font-size:18px;
}
#legalClose.closeBtn:hover{ background:#f3f4f6; }

/* Content spacing */
#legalContent{ padding:24px 24px 0; }
#legalContent h2{ margin:0 0 14px; font-size:20px; font-weight:600; }
#legalContent p{ margin:10px 0; font-size:14px; line-height:1.5; }
#legalContent ul{ margin:10px 0 10px 22px; font-size:14px; line-height:1.5; }

/* Footer s modr√Ωm CTA */
#legalFooter{
  padding:16px 24px; border-top:1px solid #eee;
  display:flex; justify-content:flex-end;
}
#legalAccept{
  background:#2a61ff; color:#fff; border:none;
  padding:10px 18px; border-radius:8px;
  font-size:14px; font-weight:600; cursor:pointer;
  box-shadow:0 4px 12px rgba(42,97,255,.35);
  transition:filter .15s ease;
}
#legalAccept:hover{ filter:brightness(1.08); }

/* Kdy≈æ je modal otev≈ôen√Ω: lock scroll + schovej mapov√© ovladaƒçe, a≈• ‚Äûnelezou p≈ôes‚Äú */
body.modal-open{ overflow:hidden; }
body.modal-open .leaflet-control-container{ display:block !important; }

/* ==== High Water Alert Badge ‚Äì lev√Ω spodn√≠ roh obr√°zku ==== */
.high-water-badge {
  position: absolute;
  bottom: 10px;
  left: 10px;

  display: none;
  align-items: center;

  padding: 6px 12px;
  border-radius: 10px;
  font: 600 13px/1.3 'Poppins', sans-serif;

  background: #fde68a;     /* nice yellow background */
  color: #991b1b;          /* strong red text */
  border: 1px solid #fcd34d;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
  z-index: 2;
}

/* ===== Current location ‚Äì oran≈æov√Ω bod + b√≠l√Ω obrys + pulz ===== */

/* divIcon wrapper ‚Äì neklikateln√Ω */
.leaflet-marker-icon.me-dot { pointer-events: none !important; }

/* samotn√Ω bod (m≈Ø≈æe≈° zvƒõt≈°it na 18‚Äì20px) */
.me-dot__core {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #0073ff; /* modr√° (Tailwind blue-500) */
  box-shadow:
    0 0 0 2px #fff,                  /* b√≠l√Ω outline */
    0 0 20px 8px rgba(0, 115, 255, .4); /* modr√Ω rozptyl (blur) */
  animation: meBlink 1s ease-in-out infinite; /* pulz opacity */
}

@keyframes meBlink{
  0%, 100% { opacity: 1; }
  50%      { opacity: .2; }
}

/* vƒõt≈°√≠ ‚Äûaccuracy‚Äú kruh ‚Äì pulzuje fill-opacity (Leaflet path v SVG) */
.leaflet-interactive.me-accuracy{
  animation: meFill 1s ease-in-out infinite;
}
@keyframes meFill{
  0%,100% { fill-opacity: .25; }
  50%     { fill-opacity: .10; }
}

/* === Desktop layout ‚Äì panels slide from right === */
@media (min-width: 992px) {
  #sidePanel,
  #updatesPanel {
    bottom: 0 !important;
    top: 0;
    left: auto;
    right: -420px;               /* panel je skryt√Ω mimo viewport */
    width: 400px;
    height: 100vh;
    transition: right 0.3s ease-out;
    box-shadow: -3px 0 6px rgba(0,0,0,.25);
    border-left: 1px solid #ddd;
  }

  #sidePanel.open,
  #updatesPanel.open {
    right: 0 !important;         /* p≈ôi otev≈ôen√≠ se posune do viewportu */
  }

  /* Uprav pozici close tlaƒç√≠tek */
  #closePanel,
  #closeUpdates {
    top: 10px;
    right: 10px;
    border-radius: 6px;
    background: #fff;
    border: 1px solid #111;
  }

  /* P≈ôizp≈Øsob mapƒõ */
  #map {
    width: 100%;
    height: 100vh;
  }

  /* Zachovej scrollov√°n√≠ obsahu uvnit≈ô panelu */
  #sidePanel,
  #updatesPanel {
    overflow-y: auto;
    overflow-x: hidden;
  }
}

/* === CUSTOM ZOOM BUTTONS (styled like Visibility/Layers) === */
.leaflet-top.leaflet-left {
  left: 20px !important;
  top: 20px !important;
}

.leaflet-control-zoom {
  border: none !important;
  box-shadow: none !important;
  background: none !important;
  margin: 0 !important;
}

.leaflet-control-zoom-in,
.leaflet-control-zoom-out {
  background: #ffffff !important;
  border: none !important;
  border-radius: 10px !important;
  width: 40px !important;
  height: 40px !important;
  line-height: 40px !important;
  font-size: 22px !important;
  font-weight: 600 !important;
  color: #000 !important;
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 0 !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.12);
}

.leaflet-control-zoom-in {
  margin-bottom: 10px !important;
}

.leaflet-control-zoom-in:hover,
.leaflet-control-zoom-out:hover {
  background: #f3f3f3 !important;
}

/* === RATING SECTION === */
.road-rating {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}

.rating-display {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.star-icon {
  flex-shrink: 0;
}

.rating-value {
  font-size: 26px;
  font-weight: 700;
  color: #000;
}

.rating-count {
  font-size: 16px;
  color: #666;
}

/* === COMPACT RATING (under route title) === */
.compact-rating {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 12px;
  margin-top: 8px;
}

.compact-star-icon {
  flex-shrink: 0;
}

.compact-rating-value {
  font-size: 13px;
  font-weight: 600;
  color: #000;
}

.compact-rating-count {
  font-size: 12px;
  color: #666;
}

.rate-button {
  width: 100%;
  padding: 10px 16px;
  background: #000;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s ease;
}

.rate-button:hover {
  background: #333;
}

/* === RATING MODAL === */
#ratingModalBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

#ratingModalBackdrop.open {
  opacity: 1;
  visibility: visible;
}

#ratingModal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: white;
  border-radius: 16px;
  padding: 32px;
  max-width: 440px;
  width: 90%;
  z-index: 10001;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

#ratingModal.open {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1);
}

#ratingModal .closeBtn {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s ease;
}

#ratingModal .closeBtn:hover {
  background: #f3f3f3;
}

#ratingContent h2 {
  margin: 0 0 8px 0;
  font-size: 24px;
  font-weight: 600;
}

.rating-stars {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin: 24px 0;
}

.rating-star {
  cursor: pointer;
  fill: #e5e7eb;
  transition: fill 0.2s ease, transform 0.2s ease;
}

.rating-star:hover {
  transform: scale(1.1);
}

.rating-star.filled {
  fill: #FFD700;
}

.rating-star.hovered {
  fill: #FFC700;
}

#ratingFooter {
  margin-top: 24px;
  display: flex;
  justify-content: center;
}

#ratingSubmit {
  padding: 12px 32px;
  background: #000;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s ease;
}

#ratingSubmit:hover:not(:disabled) {
  background: #333;
}

#ratingSubmit:disabled {
  background: #ccc;
  cursor: not-allowed;
}
  </style>
</head>

<body>
  
    <!-- Hidden vehicle selector (for JS compatibility) -->
<select id="vehicleSelect" style="display:none;">
  <option value="all" selected>All vehicles</option>
</select>

<!-- F-Roads Search Box -->
<div id="roadSearchContainer">
  <div id="roadSearchBox">
    <svg id="searchIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <input
      type="text"
      id="roadSearchInput"
      placeholder="Search F-roads..."
      autocomplete="off"
    />
    <button id="clearSearch" title="Clear search">‚úï</button>
  </div>
  <div id="searchResults"></div>
</div>

<!-- Bottom-left info box (subtle) -->
<div id="bottomInfoBox">
  <div id="currentTime"></div>
  <button id="openDisclaimer" type="button" title="Important Disclaimer">Safety notice</button>
</div>

<!-- Backdrop + Modal (white theme) -->
<div id="legalModalBackdrop" aria-hidden="true"></div>
<div id="legalModal" role="dialog" aria-modal="true" aria-labelledby="legalTitle">
  <button id="legalClose" class="closeBtn" aria-label="Close">‚úï</button>

  <div id="legalContent">
    <h2 id="legalTitle">Important Disclaimer</h2>
    <p>
      The vehicle selection and road recommendations shown here are only
      <strong>general suggestions</strong> based on common road difficulty levels.
      Actual conditions can change quickly due to weather, river flow, snow, or closures.
    </p>
    <ul>
      <li>Driving on F-roads is entirely <strong>at your own risk</strong> and the driver takes full responsibility.</li>
      <li>Always check official road conditions (<em>road.is</em>) and the weather forecast before driving.</li>
      <li>Do not attempt river crossings unless you and your vehicle are fully capable.</li>
      <li>Respect road signs, closures, and your rental company‚Äôs rules.</li>
    </ul>
    <p>
      The creators of this map accept no responsibility for damages, accidents, or fines resulting from the use of these recommendations.
    </p>
  </div>

  <div id="legalFooter">
    <button id="legalAccept" type="button">I Understand</button>
  </div>
</div>

<!-- Rating Modal -->
<div id="ratingModalBackdrop" aria-hidden="true"></div>
<div id="ratingModal" role="dialog" aria-modal="true" aria-labelledby="ratingTitle">
  <button id="ratingClose" class="closeBtn" aria-label="Close">‚úï</button>

  <div id="ratingContent">
    <h2 id="ratingTitle">Rate this F-road</h2>
    <p id="ratingRoadName" style="color: #666; margin-bottom: 20px;"></p>

    <div class="rating-stars">
      <svg class="rating-star" data-value="1" width="48" height="48" viewBox="0 0 24 24">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
      <svg class="rating-star" data-value="2" width="48" height="48" viewBox="0 0 24 24">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
      <svg class="rating-star" data-value="3" width="48" height="48" viewBox="0 0 24 24">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
      <svg class="rating-star" data-value="4" width="48" height="48" viewBox="0 0 24 24">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
      <svg class="rating-star" data-value="5" width="48" height="48" viewBox="0 0 24 24">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
    </div>

    <p id="ratingFeedback" style="text-align: center; margin-top: 16px; font-size: 14px; color: #666;"></p>
  </div>

  <div id="ratingFooter">
    <button id="ratingSubmit" type="button" disabled>Submit Rating</button>
  </div>
</div>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <div id="map"></div>
  

  <div id="updatesPanel" class="updates">
  <button id="closeUpdates">‚úï</button>
  <h2>Updates</h2>
  <ul id="updatesList" class="updates-list">
    <!-- vypln√≠ JS -->
  </ul>
</div>

<div id="updatesBtn" class="leaflet-bar">
  <a href="#" title="View updates">
    <span class="updates-icon">!</span>
  </a>
</div>

<!-- SOS 112 button (hned pod Updates) -->
<div id="sosBtn">
  <a href="tel:112" aria-label="Call emergency number 112">112</a>
</div>

<!-- Current Location button -->
<div id="currentLocationBtn">
  <a href="#" title="Current location" id="currentLocationLink">
    <img src="https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68fe1494e6a825faf56ef295_target.png" alt="Current location" />
  </a>
</div>

<!-- Satellite Toggle button -->
<div id="satelliteBtn">
  <a href="#" title="Toggle satellite view" id="satelliteLink">
    <img src="https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68f6ca8e8bd3492108cb48c8_layers.png" alt="Toggle satellite" />
  </a>
</div>

  <div id="sidePanel">
    <button id="closePanel">‚úï</button>
    <div id="roadStatusBadge" class="open">OPEN</div>
    <div id="roadImageWrapper" style="display:none;">
  <img id="roadImage" alt="Road Photo"/>
  <div class="high-water-badge">
  Caution: High Water Possible
</div>
  <button id="spGalleryBtn" type="button" title="Gallery">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="5" width="18" height="14" rx="2" fill="none" stroke="#111" stroke-width="1.6"/>
      <path d="M8 13l2-2 3 3 3-4 3 4" fill="none" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="8" cy="9" r="1.6" fill="#111"/>
    </svg>
    <span>Gallery</span>
  </button>

  
  
  <div id="galleryOverlay">
  <div id="galleryHeader">
    <span>Gallery</span>
    <button id="closeGallery" aria-label="Close gallery">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
    <line x1="6" y1="6" x2="18" y2="18" stroke-width="2" stroke-linecap="round"/>
    <line x1="6" y1="18" x2="18" y2="6" stroke-width="2" stroke-linecap="round"/>
  </svg>
</button>
  </div>
  <div id="galleryStrip"></div>
</div>
</div>
    <div id="roadDetails">
      <h2>F-road Details</h2>

      <!-- Compact Rating Display (under title) -->
      <div id="compactRating" class="compact-rating">
        <svg class="compact-star-icon" width="14" height="14" viewBox="0 0 24 24" fill="#FFD700">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <span class="compact-rating-value" id="compactRatingValue">--</span>
        <span class="compact-rating-count" id="compactRatingCount">(0)</span>
      </div>

      <!-- Weather card -->
      <div id="wxCard" class="wx-card" title="">
  
  <!-- Teplota -->
  <div class="wx-temp">
    <div id="wxIcon" class="wx-icon" aria-hidden="true"></div>
    <div class="wx-temp-num">
      <span id="wxT">--</span><span class="unit">¬∞C</span>
    </div>
  </div>

  <div class="wx-sep" aria-hidden="true"></div>

  <!-- V√≠tr -->
  <div class="wx-wind">
    <div class="wx-compass" aria-label="Wind direction">
      <svg viewBox="0 0 44 44" role="img" aria-label="Wind compass">
        <circle cx="22" cy="22" r="20" fill="#f8fafc" stroke="#dbeafe" stroke-width="1.5"/>
        <line x1="22" y1="2"  x2="22" y2="6"  stroke="#9ca3af" stroke-width="1"/>
        <line x1="22" y1="38" x2="22" y2="42" stroke="#9ca3af" stroke-width="1"/>
        <line x1="2"  y1="22" x2="6"  y2="22" stroke="#9ca3af" stroke-width="1"/>
        <line x1="38" y1="22" x2="42" y2="22" stroke="#9ca3af" stroke-width="1"/>
        <g id="wxArrow" class="arrow">
          <polygon points="22,7 18.5,17.5 25.5,17.5" fill="#e23b3b"/>
          <line x1="22" y1="17.5" x2="22" y2="31" stroke="#e23b3b" stroke-width="2" stroke-linecap="round"/>
        </g>
      </svg>
    </div>
    <div class="wx-wind-info">
      <div class="wx-wind-speed"><span id="wxF">--</span><span class="unit">m/s</span></div>
      <div class="wx-wind-dir" id="wxDtxt">--</div>
    </div>
  </div>

  <div class="wx-sep" aria-hidden="true"></div>

  <!-- Sr√°≈æky -->
  <div class="wx-precip" title="Precipitation (mm/h)">
    <div class="wx-precip-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24">
        <path d="M12 3C10 6 6 10 6 13.5A6 6 0 0 0 18 13.5C18 10 14 6 12 3z"
              fill="currentColor"/>
      </svg>
    </div>
    <div class="wx-precip-val">
      <span id="wxP">--</span><span class="unit">mm/h</span>
    </div>
  </div>

</div>

      
      <!-- Hidden fallback text (kept) -->
      <span id="wx" style="display:none">-- ¬∞C ¬∑ -- m/s</span>

      <div>
        <strong>River Crossings:</strong>
        <span id="infoRiver"></span>
      </div>

      <strong class="info-title">Informations:</strong>

      <div class="info-row">
        <span class="info-label">Difficulty:</span>
        <span id="infoDifficulty"></span>
      </div>

      <div class="info-row">
        <span class="info-label">Length:</span>
        <span id="infoLength"></span> km
      </div>

      <div class="info-row">
        <span class="info-label">Approx. Time:</span>
        <span id="infoTime"></span>
      </div>

      <div class="info-row">
        <span class="info-label">Surface:</span>
        <span id="infoSurface"></span>
      </div>

      <div class="info-row">
        <span class="info-label">Watch out for:</span>
        <span id="infoWatch"></span>
      </div>

      <!-- Reviews Section -->
      <strong class="info-title">Reviews:</strong>

      <div id="roadRating" class="road-rating">
        <div class="rating-display">
          <svg class="star-icon" width="28" height="28" viewBox="0 0 24 24" fill="#FFD700">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <span class="rating-value" id="ratingValue">--</span>
          <span class="rating-count" id="ratingCount">(0)</span>
        </div>
        <button class="rate-button" id="rateButton">Rate this road</button>
      </div>

      <!-- River crossings section is injected below -->
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDDMNnJgtm-gK9OrVev7qmBRpaA8CAoDiM",
      authDomain: "froad-7d561.firebaseapp.com",
      projectId: "froad-7d561",
      storageBucket: "froad-7d561.firebasestorage.app",
      messagingSenderId: "1086299585443",
      appId: "1:1086299585443:web:10bcb67effd6a89c24f816"
    };
    firebase.initializeApp(firebaseConfig);
    var auth = firebase.auth();
    var db = firebase.firestore();
  </script>

  <script>
    
    const minZoom = 6;
    const map = L.map('map').setView([63.9, -18.9], minZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'¬© OpenStreetMap contributors', maxZoom:19, minZoom
    }).addTo(map);
    

    /* ---- Satellite layer setup ---- */
    let isSatellite = false;
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri',
      maxZoom: 19
    });

let myLocMarker = null, myLocCircle = null;

function locateOnce(){
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy || 30;
      const latlng = [lat, lon];

      // 1) ORAN≈ΩOV√ù BOD (divIcon), ≈æ√°dn√Ω default ‚Äûpin‚Äú
      const icon = L.divIcon({
        className: 'me-dot',
        html: '<div class="me-dot__core"></div>',
        iconSize: [0,0],
        iconAnchor: [0,0]
      });
      if (!myLocMarker){
        myLocMarker = L.marker(latlng, { icon, interactive:false, keyboard:false }).addTo(map);
      } else {
        myLocMarker.setLatLng(latlng);
      }

      // 3) Kamera ‚Äì trochu p≈ôibl√≠≈æit (min zoom 13)
      map.flyTo(latlng, Math.max(map.getZoom() || 0, 13), { duration:.6 });
    },
    (err)=>{ console.warn(err); alert('Could not get location'); },
    { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
  );
}

    /* ---- Button event listeners ---- */
    // Current Location button
    document.getElementById('currentLocationLink').addEventListener('click', function(e) {
      e.preventDefault();
      locateOnce();
    });

    // Satellite Toggle button
    document.getElementById('satelliteLink').addEventListener('click', function(e) {
      e.preventDefault();
      if (!isSatellite) {
        map.addLayer(satelliteLayer);
        isSatellite = true;
        console.log('üõ∞Ô∏è Satellite view ON');
      } else {
        map.removeLayer(satelliteLayer);
        isSatellite = false;
        console.log('üó∫Ô∏è Normal view ON');
      }
    });


    /* ---- Roads (sample) ---- */

    /* ---- Campsites ---- */
    const campsites=[{
      name: "B√°sar Campsite",
      coords: [63.6771443, -19.4813471],
      link: "https://www.campsire.com/campsites-highlands/basar-hut-and-campsite-thorsmork",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68ade2efbd7011ec342300c6_688013eb5ecbffb361681c5e_basar%20thorsmrok6788.jpg"
    },

    {
      name: "Langisj√≥r Campsite",
      coords: [64.111142, -18.443615],
      link: "https://www.campsire.com/all-campsites-iceland/langisjor-campsite",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68ded5f8107b56b72806d408_langisjor-campsite.jpg"
    },

    {
      name: "Bl√°gil Campsite",
      coords: [63.9666962, -18.324],
      link: "https://www.campsire.com/campsites-highlands/blagil-hut-and-campsite",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68b84f533641d318e181c81f_blagil-campsite.jpg"
    },

    {
      name: "H√∫sadalur Volcano Huts",
      coords: [63.69101, -19.54088],
      link: "https://www.campsire.com/campsites-highlands/husadalur-volcano-huts-and-campsite-thorsmork",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68c6f4da8a596f31bd9db5e5_husadalur.jpg"
    },

    {
      name: "Hveravellir Lodge and Campsite",
      coords: [64.86664, -19.55347],
      link: "https://www.campsire.com/campsites-highlands/hveravellir-lodge-and-campsite",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68c6f2a1e724789b67c7cbd9_hveravellir.webp"
    },

    {
      name: "Landmannalaugar Campsite",
      coords: [63.99067, -19.06068],
      link: "https://www.campsire.com/campsites-highlands/landmannalaugar-camping",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68b863be2831ae1c5f4d817f_landmannalaugar-campsite.jpg"
    },

    {
      name: "Kerlingarfj√∂ll Highland Base",
      coords: [64.68343, -19.30119],
      link: "https://www.campsire.com/campsites-highlands/kerlingarfjoll-highland-base",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68c6ee46d1521df41c3f50a3_kerlingarfjoll-campsite.jpg"
    },
    {
      name: "Flateydalur Campsite",
      coords: [66.114294, -17.885838],
      link: "https://www.campsire.com/all-campsites-iceland/flateydalur-campsite",
      photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68e51abb4df0de8c142f6290_flateydalur-hut.webp"
    },

  ];
    

    const roadLayers=[];                          // lines
    const labelGroup=L.layerGroup().addTo(map);  // labels
    let crossingLayer = L.layerGroup().addTo(map);

    // midpoint (lat, lon)
    function getRoadMidLatLon(rd){
      if(!rd.coords || !rd.coords.length) return [64.1466, -21.9426];
      const line=turf.lineString(rd.coords.map(c=>[c[1],c[0]]));
      const lenKm=turf.length(line,{units:'kilometers'});
      const mid=turf.along(line, lenKm/2, {units:'kilometers'});
      const [lon,lat]=mid.geometry.coordinates; return [lat,lon];
    }

    /* ---- River crossings helpers ---- */
    // Blue circle without outline + centered small white waves
   function crossingIcon(){
  const html=`
    <div class="rc-icon">
      <svg viewBox="0 0 28 28" aria-hidden="true">
        <circle cx="14" cy="14" r="12" fill="#1d4ed8"/>
        <g transform="translate(0,0)">
          <path d="M8 11.2c2-1 4-1 6 0s4 1 6 0" stroke="#ffffff" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 14c2-1 4-1 6 0s4 1 6 0" stroke="#ffffff" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 16.8c2-1 4-1 6 0s4 1 6 0" stroke="#ffffff" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
      </svg>
    </div>`;
  return L.divIcon({ html, className:'', iconSizee:[28,28], iconAnchor:[14,14] });
}

    function resolveCrossingCoord(rd,x){
      if(x.coord && x.coord.length===2) return x.coord; // [lat,lon]
      if(typeof x.alongKm==='number'){
        const line=turf.lineString(rd.coords.map(c=>[c[1],c[0]]));
        const pt=turf.along(line, x.alongKm, {units:'kilometers'});
        return [pt.geometry.coordinates[1], pt.geometry.coordinates[0]];
      }
      return getRoadMidLatLon(rd);
    }

    function ensureRiverSection(){
      const details=document.getElementById('roadDetails');
      let sec=document.getElementById('rc-section');
      if(!sec){
        sec=document.createElement('div');
        sec.id='rc-section';
        sec.innerHTML=`
      
          <ul id="rc-list"></ul>`;
        const after=document.querySelector('#infoRiver')?.closest('div');
        if(after && after.parentNode===details) after.insertAdjacentElement('afterend', sec);
        else details.appendChild(sec);
      }
      return sec;
    }

    function renderRiverCrossings(rd){
      ensureRiverSection();
      const list=document.getElementById('rc-list');
      list.innerHTML=''; crossingLayer.clearLayers();
      const crossings=Array.isArray(rd.crossings) ? rd.crossings : [];
      if(!crossings.length){
        list.innerHTML=`<li class="rc-item" style="grid-template-columns:1fr;"><div class="rc-name">No recorded crossings</div></li>`;
        return;
      }
      crossings.forEach((x,i)=>{
        const pos=resolveCrossingCoord(rd,x);
        const marker=L.marker(pos,{ icon:crossingIcon() }).addTo(crossingLayer);

        const title=x.name||`Crossing #${i+1}`;
        const depth=(x.depth_m_est!=null) ? `${x.depth_m_est} m`:'‚Äî';
        const diff=x.difficulty||'Unknown';
        const popupHtml=`<strong>${title}</strong><br/>Difficulty: ${diff}<br/>Depth: ${depth}${x.note?`<br/><em>${x.note}</em>`:''}`;
        marker.bindPopup(popupHtml);

        const li=document.createElement('li');
        li.className='rc-item';
        li.innerHTML=`
          <div>${crossingIcon().options.html}</div>
          <div>
            <div class="rc-name">${title}</div>
            <div class="rc-metrics">Aprox.Depth: <strong>${depth}</strong>${x.note?` ¬∑ <em>${x.note}</em>`:''}</div>
          </div>
          <div class="rc-right">
            <span class="rc-badge ${String(diff).toLowerCase()}">${diff}</span>
            <button class="rc-btn" data-idx="${i}">Zoom</button>
          </div>`;
        list.appendChild(li);

        li.querySelector('.rc-btn').addEventListener('click', ()=>{
          map.flyTo(pos, Math.max(map.getZoom(), 13), { duration:.8 });
          marker.openPopup();
        });
      });
    }

   function updateRoadStatus(rd){
  const badge = document.getElementById('roadStatusBadge');
  if(!badge) return;

  const status = getRoadStatus(rd);

  // Nastav√≠ text podle stavu
  if (status === 'closed') {
    badge.textContent = 'CLOSED';
  } else if (status === 'unknown') {
    badge.textContent = 'UNKNOWN';
  } else {
    badge.textContent = 'OPEN';
  }

  // Nastav√≠ CSS t≈ô√≠dy
  badge.classList.toggle('open', status === 'open');
  badge.classList.toggle('closed', status === 'closed');
  badge.classList.toggle('unknown', status === 'unknown');
}
 

    function showPanel(rd){

  const upd = document.getElementById('updatesPanel');
  if (upd) upd.classList.remove('open');    
  const wrapper = document.getElementById('roadImageWrapper');
  const img = document.getElementById('roadImage');

  if (rd.photo) {
    img.src = rd.photo;
    wrapper.style.display = 'block';
  } else {
    img.removeAttribute('src');
    wrapper.style.display = 'none';
  }

  updateRoadStatus(rd);
  
      document.getElementById('infoDifficulty').textContent=rd.difficulty;

      const rcCount=Array.isArray(rd.crossings) ? rd.crossings.length : (rd.riverCrossing?.count ?? 0);

      document.getElementById('infoLength').textContent=rd.lengthKm;
      document.getElementById('infoTime').textContent=rd.approxTime;
      document.getElementById('infoSurface').textContent=rd.surface;
      document.getElementById('infoWatch').textContent=rd.watchOut;
      document.querySelector('#roadDetails > h2').textContent=rd.name;

      // Load rating for this road
      loadRoadRating(rd.id || rd.name);

      document.getElementById('sidePanel').classList.add('open');

      const [lat,lon]=getRoadMidLatLon(rd);
      Weather.setByCoords(lat,lon);
      fetchCurrentWeatherMS(lat, lon)
  .then(w => updateHighWaterBadge(rd, w))
  .catch(() => updateHighWaterBadge(rd, null));

renderRiverCrossings(rd);
    }

    

    // --- Road colors helper ---
const ROAD_COLORS = {
  open:   '#3bed32',  // tvoje p≈Øvodn√≠ zelen√°
  closed: '#dc2626',  // ƒçerven√° (lad√≠ s CLOSED badge)
  unknown: '#9ca3af', // svƒõtle ≈°ed√° pro unknown
  selected: '#000000' // ƒçern√° (po kliku)
};

function getRoadStatus(rd){
  // Vrac√≠: 'closed', 'unknown', nebo 'open'
  if (rd?.isOpen === false || String(rd?.status).toLowerCase() === 'closed') {
    return 'closed';
  }
  if (rd?.isOpen === 'unknown' || String(rd?.status).toLowerCase() === 'unknown') {
    return 'unknown';
  }
  return 'open';
}

function baseRoadColor(rd){
  const status = getRoadStatus(rd);
  return ROAD_COLORS[status] || ROAD_COLORS.open;
}

// kdy≈æ ru≈°√≠≈° zv√Ωraznƒõn√≠ vybran√© ƒç√°ry, vra≈• j√≠ jej√≠ "z√°kladn√≠" barvu podle isOpen
function resetPolylineStyle(polyline){
  const r = roadLayers.find(x => x.polyline === polyline);
  if (!r) return;
  r.polyline.setStyle({ color: baseRoadColor(r.data), weight: 4, opacity: 1, dashArray: null });
}


    let selectedLayer=null;
    froadData.forEach(rd=>{
      const visibleLine = L.polyline(rd.coords, {
  color: baseRoadColor(rd),
  weight: 4,
  className: 'road-main-line'
}).addTo(map);
      const bufferLine=L.polyline(rd.coords,{ color:'#000', weight:20, opacity:0, className:'road-hitbox' }).addTo(map);

      const onRoadClick=()=>{
  if (selectedLayer && selectedLayer !== visibleLine) resetPolylineStyle(selectedLayer);
  visibleLine.setStyle({ color:'#000', weight:6 });
  selectedLayer=visibleLine;
  showPanel(rd);
};
bufferLine.on('click', onRoadClick);
visibleLine.on('click', onRoadClick);

// ‚¨áÔ∏è ULO≈ΩIT si handler do struktury:
roadLayers.push({ polyline:visibleLine, data:rd, hitbox:bufferLine, onRoadClick });
      
    });

    function updateLabels(){
  labelGroup.clearLayers();                         // smazat v≈°echny star√© labely
  const zoom = map.getZoom();
  const labelsPerRoad = Math.max(1, Math.floor((zoom - minZoom)/3) + 1);

  roadLayers.forEach(r=>{
    // ‚¨ÖÔ∏è kl√≠ƒçov√° podm√≠nka: pro nevhodn√© cesty nevytv√°≈ôej v≈Øbec ≈æ√°dn√© labely
    if (r.data.allowed === false) return;

    const line = turf.lineString(r.data.coords.map(c=>[c[1],c[0]]));
    const len  = turf.length(line,{units:'kilometers'});
    const step = len/labelsPerRoad;

    for(let d=0; d<=len; d+=step){
      const pt = turf.along(line,d,{units:'kilometers'});
      const latlng = [pt.geometry.coordinates[1], pt.geometry.coordinates[0]];

      L.marker(latlng,{
        icon: L.divIcon({
          className: 'road-label-icon',            // u≈æ ≈æ√°dn√© ' dimmed'
          html: `<div>${r.data.name.split(' ')[0]}</div>`,
          iconAnchor: [12,12]
        }),
        interactive:false
      }).addTo(labelGroup);
    }
  });
}
    map.on('zoomend moveend', updateLabels);
    updateLabels();

    document.getElementById('closePanel').addEventListener('click', ()=>{
      document.getElementById('sidePanel').classList.remove('open');
      crossingLayer.clearLayers();
      if (selectedLayer) resetPolylineStyle(selectedLayer);
    });
    

    document.getElementById('vehicleSelect').addEventListener('change', e=>{
  const selected = e.target.value;

  const isAllowed = (diff, vehicle) => {
  const d = diff.toLowerCase();

  if (vehicle === 'all') return true;

  switch (vehicle) {
    // ‚úÖ Kompaktn√≠ 4x4 ‚Äì jen EASY
    case 'jimny':
    case 'renegade':
    case 'sportage':
    case 'tucson':
    case 'rav4':
    case 'outlander':
    case 'xtrail':
    case 'forester':
    case 'cx5':
      return d === 'easy';

    // ‚úÖ St≈ôedn√≠ SUV ‚Äì zvl√°dnou EASY + MEDIUM
    case 'duster':
      return d === 'easy' || d === 'medium';

    // ‚úÖ Velk√° offroad auta ‚Äì zvl√°dnou v≈°e kromƒõ EXTREME
    case 'landcruiser':
    case 'hilux':
    case 'wrangler':
    case 'defender':
    case 'discovery':
    case 'grenadier':
      return d !== 'extreme';

    // ‚úÖ Luxusn√≠ SUV ‚Äì vƒõt≈°inou na asfalt + lehƒç√≠ gravel, tak≈æe jen EASY
    case 'xc90':
    case 'x5':
    case 'gle':
    case 'gclass':
    case 'q7':
      return d === 'easy';

    // ‚úÖ Campervany 4x4 ‚Äì obvykle jen EASY nebo v√Ωjimeƒçnƒõ MEDIUM (Hilux Camper)
    case 'transporter-4x4':
    case 'sprinter-4x4':
      return d === 'easy';

    default:
      return true;
  }
};


  roadLayers.forEach(r=>{
    const allowed = isAllowed(r.data.difficulty, selected);
    r.data.allowed = allowed;

    // v≈ædy zru≈° star√© click handlery (na obou vrstv√°ch)
    r.polyline.off('click');
    r.hitbox?.off?.('click');

    if (allowed) {
      // vra≈• vrstvy do mapy (pokud u≈æ tam nejsou)
      if (!map.hasLayer(r.polyline)) map.addLayer(r.polyline);
      if (r.hitbox && !map.hasLayer(r.hitbox)) map.addLayer(r.hitbox);

      // pokud nen√≠ zrovna vybran√°, nastav "z√°kladn√≠" zelen√Ω styl
      if (selectedLayer !== r.polyline) {
  r.polyline.setStyle({ color: baseRoadColor(r.data), weight: 4, opacity: 1, dashArray: null });
}


      // zp√°tky p≈ôipoj P≈ÆVODN√ç highlight klik (na obƒõ vrstvy)
      if (r.onRoadClick) {
        r.polyline.on('click', r.onRoadClick);
        r.hitbox?.on?.('click', r.onRoadClick);
      }
    } else {
      // √∫plnƒõ skryj z mapy (i hitbox)
      if (map.hasLayer(r.polyline)) map.removeLayer(r.polyline);
      if (r.hitbox && map.hasLayer(r.hitbox)) map.removeLayer(r.hitbox);

      // kdy≈æ jsi zrovna mƒõl vybranou tuhle cestu, odvyber ji
      if (selectedLayer === r.polyline) {
        selectedLayer = null;
        // volitelnƒõ: zav≈ôi panel
        // document.getElementById('sidePanel').classList.remove('open');
      }
    }
  });

  // okam≈æitƒõ p≈ôegeneruj labely, nen√≠ t≈ôeba zoomovat
  updateLabels();
});


    /* ---- Campsite example ---- */
    /* ---- Campsites render (Poppins popup + cover) ---- */
const CAMP_ICON_URL = 'https://cdn.prod.website-files.com/687ebffd20183c0459d68784/689d0b24443379bb01061e52_tent%20(10).png';
const PLACEHOLDER_COVER = 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop';

// pokud pou≈æ√≠v√°≈° toggle, zajisti vrstvu:
window.campsitesLayer = window.campsitesLayer || L.layerGroup().addTo(map);

const campIcon = L.icon({
  iconUrl: CAMP_ICON_URL,
  iconSize: [30,30],
  iconAnchor: [12,30],
  popupAnchor: [0,-30]
});

campsites.forEach(camp=>{
  // coords:[lat,lon] nebo lat/lng
  const lat = camp.coords?.[0] ?? camp.lat;
  const lng = camp.coords?.[1] ?? camp.lng;
  if (typeof lat !== 'number' || typeof lng !== 'number') return;

  // cover v≈ædy naho≈ôe (preferuj camp.photo, pak placeholder)
  const cover = camp.photo || PLACEHOLDER_COVER;

  const html = `
    <div class="poi-card">
      <img class="poi-cover" src="${cover}" alt="${camp.name || 'Campsite'}" />
      <div class="poi-body">
        <h3 class="poi-title">${camp.name || 'Campsite'}</h3>
        <p class="poi-desc">${camp.description || camp.desc || ''}</p>
        <div class="poi-actions">
          ${camp.link ? `
            <a class="poi-btn" href="${camp.link}" target="_blank" rel="noopener">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none">
                <path d="M7 13l6-6M9 5h6v6" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              More info
            </a>` : ``}
        </div>
      </div>
    </div>
  `;

  L.marker([lat, lng], { icon: campIcon, title: camp.name || 'Campsite' })
    .addTo(window.campsitesLayer || map)  // m√°≈°-li toggle, nech to v campsitesLayer
    .bindPopup(html, {
      className: 'poi-popup',
      maxWidth: 380,
      minWidth: 260,
      autoPan: true,
      autoPanPadding: [20,20],
      closeButton: true
    });
});


    const huts = [
  {
    name: "Skagfj√∂r√∞ssk√°li Hut",
    lat: 63.6849449,
    lng: -19.5126214,
    link: "https://example.com/hut-info",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68ae0ff249c12184e1865dd2_68801a4989de05ba76b8416f_Langidalur%20thorsmrok7035-p-800.jpg"
  },
  {
    name: "Bl√°gil Hut",
    lat: 63.9666976,
    lng: -18.3219473,
    link: "https://example.com/hut-info",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68b84d0210496000a2be05fa_blagil-hut.jpg"
  },
  {
    name: "Str√∫tur Hut",
    lat: 63.83905,
    lng: -18.97444,
    link: "https://example.com/hut-info",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68d2fa0b5debc742b87c93c5_strutur-hut.jpg"
  },
  {
    name: "Nyidalur FI Mountain Hut",
    lat: 64.734942,
    lng: -18.072574,
    link: "https://www.fi.is/en/mountain-huts/all-mountain-huts/nyidalur",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68d312f811a8886b8ba28814_nyidalur-hut.jpg"
  },
  {
    name: "√ûorsteinssk√°li",
    lat: 65.19287,
    lng: -16.22264,
    link: "https://www.fi.is/is/skalar/skalar-ferdafelags-islands/thorsteinsskali",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68de7bdedbd383c39dcdf325_%C3%BEorsteinsskali.jpg"
  },
  {
    name: "J√∂kulheimar Hut",
    lat: 64.310308,
    lng: -18.238683,
    link: "https://jorfi.is/skalar/",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68debb983343ba71692c3230_jokulhemair-hut.jpg"
  },
  {
    name: "Hagavatn Hut",
    lat: 64.462549,
    lng: -20.243930,
    link: "https://www.fi.is/en/mountain-huts/all-mountain-huts/hagavatn",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68deddb6dc2b4952ac55fff3_hagavatn-hut.jpg"
  },
  {
    name: "√ûj√≥fadalir Hut",
    lat: 64.814895,
    lng: -19.708942,
    link: "https://www.fi.is/is/skalar/skalar-ferdafelags-islands/thjofadalir",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68e189b1cf566080a196e157_thjofadalir-hut.jpg"
  },
  {
    name: "Laugafell Hut",
    lat: 65.027588,
    lng: -18.332083,
    link: "https://www.fi.is/is/skalar/skalar-ferdafelags-islands/laugafell",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68e19ded309f06bd2d82b748_laugafell-hut.jpg"
  },
  {
    name: "H√∫sav√≠k Hut",
    lat: 65.395086,
    lng: -13.735203,
    link: "https://www.fi.is/en/mountain-huts/all-mountain-huts/husavik",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68e59ffa08f06c7e5eb7bfa5_husavikurskalli-hut.jpg"
  },
  {
    name: "Lo√∞mundarfjar√∞arsk√°li Hut",
    lat: 65.365173,
    lng: -13.896074,
    link: "https://www.east.is/en/service/ferdafelag-fljotsdalsherads-lodmundarfjordur-klyppstadur",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68e5a24dd6d78a1717fb1328_lodmundarfjardarskalli.webp"
  },
  {
    name: "M√∫lask√°li Hut",
    lat: 64.552585,
    lng: -15.151429,
    link: "https://gonguferdir.is/mulaskali/",
    photo: "https://cdn.prod.website-files.com/687ebffd20183c0459d68784/68e91fa34a83e3b8795a882c_mulaskali-hut.jpg"
  },

];


if (typeof map !== 'undefined' && Array.isArray(huts)) {
  window.hutsLayer = window.hutsLayer || L.layerGroup().addTo(map);

  const hutIcon = L.icon({
    iconUrl: 'https://cdn.prod.website-files.com/687ebffd20183c0459d68784/689d0a3c12784f92cf6a0fe9_hut.png',
    iconSize: [24, 24],
    iconAnchor: [12, 24],
    popupAnchor: [0, -24]
  });

  huts.forEach(hut => {
    if (!hut.lat || !hut.lng) return;

    const cover = hut.photo || 'https://images.unsplash.com/photo-1523413651479-597eb2da0ad9?q=80&w=1200&auto=format&fit=crop';

    const html = `
      <div class="poi-card">
        <img class="poi-cover" src="${cover}" alt="${hut.name}" />
        <div class="poi-body">
          <h3 class="poi-title">${hut.name}</h3>
          <p class="poi-desc">${hut.desc || ''}</p>
          <div class="poi-actions">
            ${hut.link ? `
              <a class="poi-btn" href="${hut.link}" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none">
                  <path d="M7 13l6-6M9 5h6v6" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                More info
              </a>
            ` : ''}
          </div>
        </div>
      </div>
    `;

    L.marker([hut.lat, hut.lng], {
      icon: hutIcon,
      title: hut.name
    })
    .addTo(window.hutsLayer)
    .bindPopup(html, {
      className: 'poi-popup',
      maxWidth: 380,
      minWidth: 260,
      autoPan: true,
      autoPanPadding: [20, 20],
      closeButton: true
    });
  });
}




    /* ---------- Utils ---------- */
    function round(n,p=1){ return Math.round(n * 10**p) / 10**p; }
    function degToCompass(deg){
      const dirs=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      return dirs[Math.round((((deg%360)+360)%360)/22.5)%16];
    }

    /* ---------- Weather icon pack ---------- */
    function weatherIconSvg(code=0, isDay=1){
      const sun = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="4.5" fill="currentColor"/>
          <g stroke="currentColor" stroke-linecap="round" stroke-width="1.8" fill="none">
            <line x1="12" y1="1.8" x2="12" y2="5.0"/>
            <line x1="12" y1="19.0" x2="12" y2="22.2"/>
            <line x1="1.8" y1="12" x2="5.0" y2="12"/>
            <line x1="19.0" y1="12" x2="22.2" y2="12"/>
            <line x1="4.3" y1="4.3" x2="6.6" y2="6.6"/>
            <line x1="17.4" y1="17.4" x2="19.7" y2="19.7"/>
            <line x1="4.3" y1="19.7" x2="6.6" y2="17.4"/>
            <line x1="17.4" y1="6.6" x2="19.7" y2="4.3"/>
          </g>
        </svg>`;
      const cloud = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M8 18h8a4 4 0 0 0 0-8 6 6 0 0 0-11-1.8A4.5 4.5 0 0 0 8 18z"/>
        </svg>`;
      const rain = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M8 14h8a4 4 0 0 0 0-8 6 6 0 0 0-11-1.8A4.5 4.5 0 0 0 8 14z"/>
          <g fill="currentColor" opacity=".9">
            <rect x="8" y="15.5" width="2" height="4" rx="1"/>
            <rect x="12" y="16.5" width="2" height="4" rx="1"/>
            <rect x="16" y="15.8" width="2" height="4" rx="1"/>
          </g>
        </svg>`;
      const snow = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M8 14h8a4 4 0 0 0 0-8 6 6 0 0 0-11-1.8A4.5 4.5 0 0 0 8 14z"/>
          <g fill="currentColor" opacity=".9">
            <circle cx="9" cy="18" r="1.2"/><circle cx="12" cy="19" r="1.2"/><circle cx="15" cy="18" r="1.2"/>
          </g>
        </svg>`;
      const fog = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M8 13h8a4 4 0 0 0 0-8 6 6 0 0 0-11-1.8A4.5 4.5 0 0 0 8 13z"/>
          <g stroke="currentColor" stroke-linecap="round" stroke-width="1.6">
            <line x1="4" y1="16" x2="20" y2="16"/>
            <line x1="6" y1="19" x2="18" y2="19"/>
          </g>
        </svg>`;
      if(code===0) return sun;                               // clear
      if([1,2,3].includes(code)) return isDay ? sun : cloud; // mainly clear
      if([45,48].includes(code)) return fog;                 // fog
      if([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return rain; // drizzle/rain
      if([71,73,75,77,85,86].includes(code)) return snow;    // snow
      if([95,96,99].includes(code)) return rain;             // thunder -> rain fallback
      return cloud;
    }

    /* ---------- Weather fetch + renderer ---------- */
    function renderWxCard({ T, F, Ddeg, code, isDay, timeISO, Pmm }){
  const elT=document.getElementById('wxT');
  const elF=document.getElementById('wxF');
  const elD=document.getElementById('wxDtxt');
  const elArrow=document.getElementById('wxArrow');
  const elIcon=document.getElementById('wxIcon');
  const card=document.getElementById('wxCard');
  const elP=document.getElementById('wxP'); // ‚úö

  if(elT) elT.textContent=(T!=null)?round(T,1):'--';
  if(elF) elF.textContent=(F!=null)?round(F,1):'--';
  if(elD) elD.textContent=(Ddeg!=null)?degToCompass(Ddeg):'--';
  if(elArrow && Ddeg!=null) elArrow.style.transform=`rotate(${Ddeg}deg)`;
  if(elIcon) elIcon.innerHTML = weatherIconSvg(code, isDay);
  if(card && timeISO){
    try{ card.title=`Updated: ${new Date(timeISO).toLocaleString('en-IS',{ timeZone:'Atlantic/Reykjavik' })}`; }catch(e){}
  }
  // ‚úö sr√°≈æky
  if(elP) elP.textContent = (Pmm!=null) ? round(Pmm,1) : '--';

      // Hidden fallback text
      const fallback=document.getElementById('wx');
      if(fallback){
        const Dtxt=(Ddeg!=null)?' '+degToCompass(Ddeg):'';
        fallback.textContent=`${T!=null?round(T,1):'--'} ¬∞C ¬∑ ${F!=null?round(F,1):'--'} m/s${Dtxt}`;
      }
    }

    async function fetchCurrentWeatherMS(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast`
            + `?latitude=${lat}&longitude=${lon}`
            + `&current_weather=true&windspeed_unit=ms`
            + `&hourly=precipitation`
            + `&past_days=2`
            + `&forecast_days=1`
            + `&timezone=Atlantic%2FReykjavik`;

  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error('HTTP '+res.status);
  const data = await res.json();

  const cw = data.current_weather;
  if(!cw) throw new Error('No current_weather');

  let P = null, sum24 = null;

  if (data.hourly?.time?.length && data.hourly?.precipitation?.length){
    const times = data.hourly.time.map(t => new Date(t).getTime());
    const arr   = data.hourly.precipitation.map(v => (typeof v === 'number') ? Math.max(0, v) : 0);
    const target = new Date(cw.time).getTime();

    // index nejbli≈æ≈°√≠ hodinƒõ k "teƒè"
    let idx = 0, best = Infinity;
    for (let i=0; i<times.length; i++){
      const diff = Math.abs(times[i] - target);
      if (diff < best){ best = diff; idx = i; }
    }

    P = arr[idx] ?? null;                      // aktu√°ln√≠ mm/h
    const from24 = Math.max(0, idx - 24);      // posledn√≠ch 24 hodin
    sum24 = arr.slice(from24, idx).reduce((s,v)=>s+v, 0);
  }

  return {
    T: cw.temperature,
    F: cw.windspeed,
    Ddeg: cw.winddirection,
    code: cw.weathercode,
    isDay: cw.is_day,
    timeISO: cw.time,
    Pmm: P,                // mm/h
    precipSum24: sum24     // ‚¨ÖÔ∏è novƒõ: souƒçet mm za posledn√≠ch 24 h
  };
}

function roadHasCrossings(rd){
  return !!(rd?.crossings?.length || rd?.riverCrossing?.exists || rd?.hasFords);
}

function shouldShowHighWaterBadge(rd, weather){
  if (!weather) return false;
  const sum24 = Number(weather.precipSum24) || 0;
  return roadHasCrossings(rd) && sum24 >= 8;   // TV≈ÆJ PR√ÅH
}

function updateHighWaterBadge(rd, weather){
  const el = document.querySelector('#roadImageWrapper .high-water-badge');
  if (!el) return; // badge v HTML u≈æ m√°≈°
  if (shouldShowHighWaterBadge(rd, weather)) {
    el.style.display = 'inline-flex';
    el.title = `Last 24h precipitation: ${Math.round(weather.precipSum24)} mm`;
  } else {
    el.style.display = 'none';
    el.title = '';
  }
}




    const Weather=(()=>{
      let timer=null; const REFRESH_MS=10*60*1000; let last={ lat:null, lon:null };
      async function update(lat,lon){
        try{ const w=await fetchCurrentWeatherMS(lat,lon); renderWxCard(w); }
        catch(e){ console.error('Weather fetch failed:', e); renderWxCard({ T:null,F:null,Ddeg:null,code:2,isDay:1,timeISO:null }); }
      }
      function start(lat,lon){ if(timer) clearInterval(timer); last={lat,lon}; update(lat,lon); timer=setInterval(()=>update(last.lat,last.lon), REFRESH_MS); }
      function setByCoords(lat,lon){ start(lat,lon); }
      return { setByCoords };
    })();

    (function(){
  let __currentRoad = null;

  // p≈ôid√°me zapamatov√°n√≠ aktu√°ln√≠ road do showPanel
  const origShowPanel = window.showPanel;
  window.showPanel = function(rd){
    __currentRoad = rd;
    if (origShowPanel) origShowPanel(rd);
  };

  function buildFullscreenGallery(rd){
    const strip = document.getElementById('galleryStrip');
    if (!strip) return;
    const urls = Array.isArray(rd.gallery) ? rd.gallery.filter(u => u && u.trim()) : [];
    strip.innerHTML = urls.length
      ? urls.map((src,i)=>`
          <figure class="gal-slide">
            <img src="${src}" alt="${rd.name ? rd.name+' photo '+(i+1) : 'Gallery photo'}" loading="lazy"/>
            <figcaption class="gal-cap">${rd.name || ''}</figcaption>
          </figure>
        `).join('')
      : `<div style="color:#ccc; margin:auto;">No gallery photos</div>`;
  }

  function openGallery(){
  if (!__currentRoad) return;
  buildFullscreenGallery(__currentRoad);
  document.getElementById('galleryOverlay').classList.add('open');
  document.documentElement.style.overflow = 'hidden';
  document.body.classList.add('gallery-open');     // ‚¨ÖÔ∏è p≈ôidat
}

function closeGallery(){
  document.getElementById('galleryOverlay').classList.remove('open');
  document.documentElement.style.overflow = '';
  document.body.classList.remove('gallery-open');  // ‚¨ÖÔ∏è odebrat
}

  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('spGalleryBtn');
    if (btn) btn.addEventListener('click', e=>{ e.preventDefault(); openGallery(); });
    document.getElementById('closeGallery').addEventListener('click', closeGallery);
  });

  window.openGallery = openGallery;
  window.closeGallery = closeGallery;
})();


  </script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // 1) P≈ôesu≈à overlay p≈ô√≠mo pod <body>, kdyby byl omylem uvnit≈ô #sidePanel apod.
  const ov = document.getElementById('galleryOverlay');
  if (ov && ov.parentElement !== document.body) {
    document.body.appendChild(ov);
  }
});

</script>

<script>
const UPDATES = [
  { type:'warning', time:'21:32, 30.8.2025', text:'Please notice that due to weather and extreme water level, the southern highlands, including Fjallabak south and north, as well as the Laki area. Travellers are strongly advised not to travel in the area.' },
  { type:'info',    time:'14:10, 20.8.2025', text:'F249 √û√≥rsmerkurvegur is open, but river levels are above average. Drive with caution.' },
  { type:'notice',  time:'09:05, 27.8.2025', text:'General reminder: Always check road.is before traveling on F-roads.' },
];

function parseUpdateTime(str){
  const m = String(str).match(/^\s*(\d{1,2}):(\d{2})\s*,\s*(\d{1,2})\.(\d{1,2})\.(\d{4})\s*$/);
  if (!m) return null;
  const hh=+m[1], mm=+m[2], d=+m[3], mon=+m[4], y=+m[5];
  return new Date(Date.UTC(y, mon-1, d, hh, mm));
}
function pad2(n){ return (n<10?'0':'')+n; }
function formatRelativeLabel(dateUtc){
  if (!(dateUtc instanceof Date)) return '--';
  const now=new Date();
  const todayMid = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
  const dateMid  = Date.UTC(dateUtc.getUTCFullYear(), dateUtc.getUTCMonth(), dateUtc.getUTCDate());
  const diffDays = Math.floor((todayMid - dateMid)/86400000);
  const hhmm = `${pad2(dateUtc.getUTCHours())}:${pad2(dateUtc.getUTCMinutes())}`;
  if (diffDays===0) return `Today ¬∑ ${hhmm}`;
  if (diffDays===1) return `Yesterday ¬∑ ${hhmm}`;
  return `${diffDays} days ago ¬∑ ${hhmm}`;
}

function renderUpdates(){
  const list = document.getElementById('updatesList');
  if (!list) return;
  list.innerHTML = '';
  const items = [...UPDATES].sort((a,b)=>{
    const da = parseUpdateTime(a.time)?.getTime() ?? 0;
    const db = parseUpdateTime(b.time)?.getTime() ?? 0;
    return db - da;
  });
  items.forEach(u=>{
    const when = parseUpdateTime(u.time);
    const li = document.createElement('li');
    li.className = `update-item ${u.type||'info'}`;
    li.innerHTML = `
      <div class="update-time" title="${when ? when.toUTCString().replace('GMT','UTC') : ''}">
        ${when ? formatRelativeLabel(when) : u.time}
      </div>
      <div class="update-text">${u.text}</div>
    `;
    list.appendChild(li);
  });
}

function openUpdatesPanel(){
  renderUpdates();
  document.getElementById('updatesPanel')?.classList.add('open');
}
function closeUpdatesPanel(){
  document.getElementById('updatesPanel')?.classList.remove('open');
}

document.addEventListener('DOMContentLoaded', ()=>{
  const AUTO_OPEN_ON_LOAD = true; // ‚Üê nastav na false, pokud nechce≈° auto-open

  // zapojen√≠ tlaƒç√≠tek (podle tv√©ho HTML m≈Ø≈æe b√Ωt #updatesBtn nebo #updatesBtn a > a)
  const btnWrap = document.getElementById('updatesBtn');
  const btn = btnWrap?.querySelector('a') || btnWrap; 
  btn?.addEventListener('click', (e)=>{ e.preventDefault(); openUpdatesPanel(); });

  document.getElementById('closeUpdates')?.addEventListener('click', closeUpdatesPanel);

  // prvn√≠ render
  renderUpdates();

  // AUTO-OPEN hned po naƒçten√≠ (to ti chybƒõlo)
  if (AUTO_OPEN_ON_LOAD) openUpdatesPanel();

  // p≈ôepoƒçet relativn√≠ch ≈°t√≠tk≈Ø ka≈ædou minutu
  setInterval(renderUpdates, 60*1000);
});


// === ƒåas do bottom-left boxu (CS form√°t) ===
(function(){
  const el = document.getElementById('currentTime');
  function tick(){
    const now = new Date();
    const d = now.toLocaleDateString('en-GB', { 
  day:'2-digit', month:'2-digit', year:'numeric',
  timeZone: 'Atlantic/Reykjavik'
});
const t = now.toLocaleTimeString('en-GB', { 
  hour:'2-digit', minute:'2-digit',
  timeZone: 'Atlantic/Reykjavik'
});

    if (el) el.textContent = `${d} ¬∑ ${t}`;
  }
  tick(); setInterval(tick, 1000);
})();

// === Modal open/close ‚Äì 1x Close, b√≠l√© UI, nep≈ôekr√Ωv√° side panel ===
(function(){
  const body     = document.body;
  const backdrop = document.getElementById('legalModalBackdrop');
  const modal    = document.getElementById('legalModal');
  const trigger  = document.getElementById('openDisclaimer');

  function openModal(){
    if (!backdrop || !modal) return;
    body.classList.add('modal-open');
    backdrop.classList.add('open');
    modal.classList.add('open');
  }
  function closeModal(){
    if (!backdrop || !modal) return;
    modal.classList.remove('open');
    backdrop.classList.remove('open');
    body.classList.remove('modal-open');
  }

  

  // Delegovan√Ω posluchaƒç: funguje i kdy≈æ je modal re-renderov√°n
  document.addEventListener('click', (e)=>{
    const t = e.target;

    // otev≈ôen√≠
    if (t.closest('#openDisclaimer')) {
      e.preventDefault();
      openModal();
      return;
    }

    // zav≈ôen√≠ p≈ôes k≈ô√≠≈æek nebo ‚ÄûI Understand‚Äú
    if (t.closest('#legalClose') || t.closest('#legalAccept')) {
      e.preventDefault();
      closeModal();
      return;
    }

    // klik na backdrop mimo modal zav≈ôe
    if (backdrop && t === backdrop) {
      closeModal();
    }
  });

  // ESC zav≈ôe
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape' && modal?.classList.contains('open')) {
      closeModal();
    }
  });
})();

// ===== Vehicle filter: abecedn√≠ ≈ôazen√≠ (All naho≈ôe) =====
(function sortVehicleFilterInit(){
  const SELECT_ID = 'vehicleSelect';

  function isAllOption(opt){
    if (!opt) return false;
    const v = String(opt.value || '').toLowerCase();
    const t = String(opt.textContent || '').toLowerCase();
    return v === 'all' || t.includes('all vehicles') || t.trim() === 'all';
  }

  function sortVehicleSelect(){
    const sel = document.getElementById(SELECT_ID);
    if (!sel) return;

    // zapamatuj si v√Ωbƒõr
    const prev = sel.value;

    // v≈°echny p≈ô√≠m√© <option> (bez optgroup)
    const options = Array.from(sel.querySelectorAll(':scope > option'));

    // oddƒõl ‚ÄûAll‚Äú od ostatn√≠ch
    const allOpts   = options.filter(isAllOption);
    const otherOpts = options.filter(o => !isAllOption(o));

    // set≈ôiƒè podle textu ‚Äì bez ohledu na velikost p√≠smen/diakritiku
    otherOpts.sort((a,b)=> a.textContent.localeCompare(b.textContent, undefined, { sensitivity:'base' }));

    // slo≈æ zpƒõt
    sel.innerHTML = '';
    [...allOpts, ...otherOpts].forEach(o => sel.appendChild(o));

    // obnov p≈Øvodn√≠ v√Ωbƒõr, p≈ô√≠padnƒõ zvol ‚ÄûAll‚Äú
    if (Array.from(sel.options).some(o => o.value === prev)) {
      sel.value = prev;
    } else if (allOpts[0]) {
      sel.value = allOpts[0].value;
    }

    // vyst≈ôel change, pokud na nƒõj navazuje≈° logiku mapy/filtru
    sel.dispatchEvent(new Event('change', { bubbles:true }));
  }

  // Spus≈• po naƒçten√≠ DOMu
  document.addEventListener('DOMContentLoaded', sortVehicleSelect);

  // Kdyby se options mƒõnily dynamicky, p≈ôerovnej znovu
  const mo = new MutationObserver((muts)=>{
    if (muts.some(m => [...m.addedNodes, ...m.removedNodes].some(n => n.nodeName === 'OPTION'))) {
      sortVehicleSelect();
    }
  });
  document.addEventListener('DOMContentLoaded', ()=>{
    const sel = document.getElementById(SELECT_ID);
    if (sel) mo.observe(sel, { childList:true });
  });
})();

</script>
  <script src="froads-data.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const panel = document.getElementById('sidePanel');
  const closeBtn = document.getElementById('closePanel');
  let isRoadClick = false; // flag

  // Klik na cestu ‚Üí otev≈ôi panel
  map.eachLayer(layer => {
    if (layer instanceof L.Polyline && !layer._url) { // vynech tilelayer
      layer.on('click', () => {
        isRoadClick = true;
        panel.classList.add('open');
      });
    }
  });

  // Klik mimo panel ‚Üí zav≈ôi (ale ignoruj klik na cestu nebo river crossing)
  document.addEventListener('click', (e) => {
    const clickedInsidePanel = panel.contains(e.target);
    const clickedClose = closeBtn.contains(e.target);

    // üí° v√Ωjimka: klik na river crossing ikonku nebo tlaƒç√≠tko
    if (e.target.closest('.rc-icon') || e.target.closest('.rc-btn')) return;

    if (isRoadClick) { isRoadClick = false; return; } // pr√°vƒõ klik na cestu, nech b√Ωt
    if (clickedInsidePanel || clickedClose) return;
    if (!panel.classList.contains('open')) return;

    // pou≈æij p≈ôesnƒõ tv≈Øj syst√©m zav√≠r√°n√≠
    closeBtn.click();
  });
});

// ===== RATING SYSTEM =====
let currentRoadId = null;
let selectedRating = 0;

// Load rating for road
async function loadRoadRating(roadId) {
  currentRoadId = roadId;
  try {
    const ratingDoc = await db.collection('ratings').doc(roadId).get();
    const ratingValue = document.getElementById('ratingValue');
    const ratingCount = document.getElementById('ratingCount');
    const compactRatingValue = document.getElementById('compactRatingValue');
    const compactRatingCount = document.getElementById('compactRatingCount');

    if (ratingDoc.exists) {
      const data = ratingDoc.data();
      const avgRating = (data.averageRating || 0).toFixed(1);
      const totalCount = `(${data.totalRatings || 0})`;

      ratingValue.textContent = avgRating;
      ratingCount.textContent = totalCount;
      compactRatingValue.textContent = avgRating;
      compactRatingCount.textContent = totalCount;
    } else {
      ratingValue.textContent = '--';
      ratingCount.textContent = '(0)';
      compactRatingValue.textContent = '--';
      compactRatingCount.textContent = '(0)';
    }
  } catch (err) {
    console.error('Error loading rating:', err);
    document.getElementById('ratingValue').textContent = '--';
    document.getElementById('ratingCount').textContent = '(0)';
    document.getElementById('compactRatingValue').textContent = '--';
    document.getElementById('compactRatingCount').textContent = '(0)';
  }
}

// Open rating modal
document.getElementById('rateButton').addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) {
    alert('Please log in to rate roads');
    return;
  }

  if (!currentRoadId) return;

  // Check if user already rated
  try {
    const userRatingDoc = await db
      .doc(`ratings/${currentRoadId}/userRatings/${user.uid}`)
      .get();

    if (userRatingDoc.exists) {
      selectedRating = userRatingDoc.data().rating;
      updateStarDisplay(selectedRating);
    } else {
      selectedRating = 0;
      updateStarDisplay(0);
    }

    // Show road name in modal
    const roadName = document.querySelector('#roadDetails > h2').textContent;
    document.getElementById('ratingRoadName').textContent = roadName;

    // Open modal
    document.getElementById('ratingModalBackdrop').classList.add('open');
    document.getElementById('ratingModal').classList.add('open');
  } catch (err) {
    console.error('Error checking existing rating:', err);
    alert('Failed to open rating modal');
  }
});

// Close modal
function closeRatingModal() {
  document.getElementById('ratingModalBackdrop').classList.remove('open');
  document.getElementById('ratingModal').classList.remove('open');
  selectedRating = 0;
  updateStarDisplay(0);
  document.getElementById('ratingFeedback').textContent = '';
}

document.getElementById('ratingClose').addEventListener('click', closeRatingModal);
document.getElementById('ratingModalBackdrop').addEventListener('click', closeRatingModal);

// Star interaction
const stars = document.querySelectorAll('.rating-star');
stars.forEach((star, index) => {
  star.addEventListener('click', () => {
    selectedRating = index + 1;
    updateStarDisplay(selectedRating);
    document.getElementById('ratingSubmit').disabled = false;

    const labels = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
    document.getElementById('ratingFeedback').textContent = labels[index];
  });

  star.addEventListener('mouseenter', () => {
    const hoverValue = index + 1;
    stars.forEach((s, i) => {
      if (i < hoverValue) {
        s.classList.add('hovered');
      } else {
        s.classList.remove('hovered');
      }
    });
  });

  star.addEventListener('mouseleave', () => {
    stars.forEach(s => s.classList.remove('hovered'));
  });
});

function updateStarDisplay(rating) {
  stars.forEach((star, index) => {
    if (index < rating) {
      star.classList.add('filled');
    } else {
      star.classList.remove('filled');
    }
  });
}

// Submit rating
document.getElementById('ratingSubmit').addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user || !currentRoadId || selectedRating === 0) return;

  const submitBtn = document.getElementById('ratingSubmit');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  try {
    // Save user rating
    await db.doc(`ratings/${currentRoadId}/userRatings/${user.uid}`).set({
      rating: selectedRating,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Recalculate average (client-side for now)
    const userRatingsSnap = await db
      .collection(`ratings/${currentRoadId}/userRatings`)
      .get();

    let sum = 0;
    let count = 0;
    userRatingsSnap.forEach(doc => {
      sum += doc.data().rating;
      count++;
    });

    const average = count > 0 ? Math.round((sum / count) * 10) / 10 : 0;

    // Update stats
    await db.doc(`ratings/${currentRoadId}`).set({
      averageRating: average,
      totalRatings: count,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Reload rating display
    await loadRoadRating(currentRoadId);

    // Close modal
    closeRatingModal();

    // Show success
    alert('Rating submitted successfully!');
  } catch (err) {
    console.error('Error submitting rating:', err);
    alert('Failed to submit rating. Please try again.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Rating';
  }
});

// ===== F-Roads Search Functionality =====
(function initRoadSearch() {
  const searchInput = document.getElementById('roadSearchInput');
  const searchResults = document.getElementById('searchResults');
  const clearBtn = document.getElementById('clearSearch');

  if (!searchInput || !searchResults) return;

  // Normalization functions
  function removeDiacritics(str) {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  function normalizeText(str) {
    return removeDiacritics(str).toLowerCase().replace(/\s+/g, '');
  }

  // Search and filter roads
  function searchRoads(query) {
    if (!query || query.trim().length < 1) return [];

    const normalizedQuery = normalizeText(query);

    return roadLayers
      .filter(r => {
        const roadName = r.data.name || '';
        const normalizedName = normalizeText(roadName);

        // Match full name or just the road number (e.g., "F229" or "214")
        const roadNumber = roadName.split(' ')[0];
        const normalizedNumber = normalizeText(roadNumber);

        return normalizedName.includes(normalizedQuery) ||
               normalizedNumber.includes(normalizedQuery);
      })
      .slice(0, 10); // Limit to 10 results
  }

  // Display search results
  function displayResults(results) {
    searchResults.innerHTML = '';

    if (results.length === 0) {
      searchResults.innerHTML = '<div class="search-no-results">No roads found</div>';
      searchResults.classList.add('show');
      return;
    }

    results.forEach(roadLayer => {
      const road = roadLayer.data;
      const item = document.createElement('div');
      item.className = 'search-result-item';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'search-result-name';
      nameDiv.textContent = road.name;

      const infoDiv = document.createElement('div');
      infoDiv.className = 'search-result-info';
      infoDiv.textContent = `${road.lengthKm || '--'} km ¬∑ ${road.difficulty || '--'}`;

      item.appendChild(nameDiv);
      item.appendChild(infoDiv);

      // Handle click
      item.addEventListener('click', () => {
        selectRoad(roadLayer);
        searchInput.value = road.name;
        clearBtn.classList.add('show'); // Keep clear button visible with result name
        hideResults();
      });

      searchResults.appendChild(item);
    });

    searchResults.classList.add('show');
  }

  // Hide results dropdown
  function hideResults() {
    searchResults.classList.remove('show');
  }

  // Select and zoom to road
  function selectRoad(roadLayer) {
    // Simulate road click to show panel and highlight
    if (roadLayer.onRoadClick) {
      roadLayer.onRoadClick();
    }

    // Zoom to road bounds with slight zoom in
    if (roadLayer.polyline) {
      const bounds = roadLayer.polyline.getBounds();
      map.fitBounds(bounds, {
        padding: [50, 50],
        maxZoom: 11 // Slight zoom in
      });
    }
  }

  // Event listeners
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value;

    // Show/hide clear button
    if (query.length > 0) {
      clearBtn.classList.add('show');
    } else {
      clearBtn.classList.remove('show');
    }

    if (query.trim().length === 0) {
      hideResults();
      return;
    }

    const results = searchRoads(query);
    displayResults(results);
  });

  searchInput.addEventListener('focus', (e) => {
    if (e.target.value.trim().length > 0) {
      const results = searchRoads(e.target.value);
      displayResults(results);
    }
  });

  // Clear button
  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    clearBtn.classList.remove('show');
    hideResults();
    searchInput.focus();
  });

  // Close results when clicking outside
  document.addEventListener('click', (e) => {
    const container = document.getElementById('roadSearchContainer');
    if (container && !container.contains(e.target)) {
      hideResults();
    }
  });

  // Handle Enter key
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const results = searchRoads(searchInput.value);
      if (results.length > 0) {
        selectRoad(results[0]);
        searchInput.value = results[0].data.name;
        clearBtn.classList.add('show'); // Keep clear button visible with result name
        hideResults();
      }
    }
  });
})();

</script>



</body>
</html>
